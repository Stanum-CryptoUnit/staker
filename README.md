# staker

Контракт выплачивает CRU согласно выбранному плану стейка и количеству застейканных пользователем монет. Контракт позволяет добавлять неограниченное количество планов стейка.

Для добавления эмиссионного плана вызываем действие:
setplan(uint64_t id, std::string name, uint64_t pause, uint64_t duration_sec, uint64_t emit_percent, uint64_t bonus_percent);
id - уникальный идентификатор плана;
name - строковое название плана;
pause - время паузы до первой выплаты в секундах.
duration - продолжительность выплат в секундах
emit_percent - процент эмиссии за один эмисионный шаг, доступные к моментальному выводу в любой момент после начисления. 
bonus_percent - процент эмиссии за один эмиссионный шаг, доступные к выводу после завершения всех выплат по плану.

Шаг эмиссии фиксирован для контракта и равен 30 дням. Все доступные планы могут быть просмотрены в таблице plans(staker, staker). Поле total_staked сообщает о том, сколько токенов пользователей отправлено в стейк по этому плану, поле plan_to_pay - сообщает о том, сколько токенов планируется выплатить пользователям в качестве вознаграждений. 

```[{
      "id": 1,
      "name": "накопительный",
      "is_active": 1,
      "pause": 0,
      "duration": 7776000,
      "emit_percent": 12000,
      "bonus_percent": 0,
      "count": 0,
      "plan_to_pay": "0 CRU",
      "total_staked": "0 CRU"
    },{
      "id": 2,
      "name": "классический",
      "is_active": 1,
      "pause": 0,
      "duration": 15552000,
      "emit_percent": 15000,
      "bonus_percent": 0,
      "count": 0,
      "plan_to_pay": "0 CRU",
      "total_staked": "0 CRU"
    },{
      "id": 3,
      "name": "оптимальный",
      "is_active": 1,
      "pause": 0,
      "duration": 31104000,
      "emit_percent": 18000,
      "bonus_percent": 0,
      "count": 0,
      "plan_to_pay": "0 CRU",
      "total_staked": "0 CRU"
    },{
      "id": 4,
      "name": "уверенный",
      "is_active": 1,
      "pause": 0,
      "duration": 46656000,
      "emit_percent": 20000,
      "bonus_percent": 0,
      "count": 0,
      "plan_to_pay": "0 CRU",
      "total_staked": "0 CRU"
    },{
      "id": 5,
      "name": "выгодный",
      "is_active": 1,
      "pause": 0,
      "duration": 62208000,
      "emit_percent": 25000,
      "bonus_percent": 0,
      "count": 0,
      "plan_to_pay": "0 CRU",
      "total_staked": "0 CRU"
    },{
      "id": 6,
      "name": "эвенти2020",
      "is_active": 1,
      "pause": 15552000,
      "duration": 93312000,
      "emit_percent": 40000,
      "bonus_percent": 40000,
      "count": 100,
      "plan_to_pay": "0 CRU",
      "total_staked": "0 CRU"
    }
  ],
```

Для того, чтобы совершить стейк по плану, пользователь должен отправить CRU на контракт staker, указав в поле memo ID выбранного плана:

cleos transfer tester staker “1000 CRU” “1” - пользователю будет начислен объект стейка по плану 1 

Для того, чтобы получить объекты стейка пользователя, необходимо получить таблицу stakeobjects(staker, username) из области памяти пользователя:

```
{
      "id": 89,
      "plan_id": 6,
      "created_at": "2020-11-27T08:26:46",
      "freeze_until": "2021-05-26T08:26:46",
      "last_update_at": "2020-11-27T08:26:46",
      "last_pay_should_be_at": "2024-05-10T08:26:46",
      "staked_balance": "1000 CRU",
      "closed": 0,
      "plan_to_pay": "2880 CRU",
      "emitted_balance": "0 CRU",
      "emitted_segments": "0.00000000000000000",
      "bonus_balance": "0 CRU",
      "bonus_segments": "0.00000000000000000",
      "withdrawed": "0 CRU"
    }
```

После получения объекта стейка, его необходимо обновлять до момента наступления даты last_pay_should_be_at. Обновление происходит вызовом метода:
```
refresh(eosio::name staker, uint64_t stake_id), где
  staker - имя аккаунта пользователя, 
  stake_id - уникальный идентификатор объекта стейка.
```
После обновления объекта стейка, если в нем должны произойти начисления, изменится объем токенов в поле emitted_balance и emitted_segments (если объем начисления меньше 1 CRU). Кроме того, начисления будут производиться и в поле bonus_balance согласно проценту начисления бонуса, установленного планом. 

Токены из поля emitted_balance могут быть извлечены из объекта вызовом метода:
```
withdraw(eosio::name staker, uint64_t stake_id, eosio::asset quantity), где
  staker - имя аккаунта пользователя,
  stake_id - уникальный идентификатор объекта стейка,
  quantity - сумма к выводу из объекта.
```

После чего, токены будут перечислены с аккаунта контракта staker на аккаунт контракта пользователя. 

Если объект стейка полностью завершил начисления, т.е. дата в поле last_update_at соответствует той, что установлена в поле last_pay_should_be_at, то в момент вывода пользователю будут перечислены токены в том числе из полей bonus_balance и staked_balance. Таким образом, объект стейка будет полностью выплачен (включая сумму вклада) и помечен флагом "closed": 1.

Остановка приема стейка по плану осуществляется вызовом метода 
```
stopplan(uint64_t plan_id), 
  где plan_id - идентификатор плана. 
```

Прием новых объектов стейка по выбранному плану будет остановлен, старые выплаты будут продолжаться. Возобновление работы плана невозможно. 
